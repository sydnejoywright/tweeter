AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: SAM config for Tweeter server
Globals:
  Function:
    Runtime: nodejs20.x
    CodeUri: ./dist/
    Layers:
    - Ref: tweeterLayer
    Timeout: 30
    MemorySize: 128
    Environment:
      Variables:
        USERS_TABLE:
          Ref: usersTable
        SESSIONS_TABLE:
          Ref: sessionsTable
        STATUS_TABLE:
          Ref: statusTable
        FOLLOW_TABLE:
          Ref: followTable
        S3_BUCKET:
          Ref: profilePicsBucket
Metadata:
  x-common-policies:
  - AWSLambdaBasicExecutionRole
  - AmazonSESFullAccess
  - CloudWatchFullAccess
  - AmazonDynamoDBFullAccess
  - AmazonS3FullAccess
  - AmazonSQSFullAccess
  x-common-cors-headers:
    method.response.header.Access-Control-Allow-Origin: '''*'''
  x-common-swagger-response-headers:
    Access-Control-Allow-Origin:
      type: string
Resources:
  tweeterApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: tweeterApi
      StageName: prod
      Cors:
        AllowMethods: '''GET,POST,PUT,DELETE'''
        AllowHeaders: '''*'''
        AllowOrigin: '''*'''
      DefinitionBody:
        swagger: '2.0'
        info:
          title: Tweeter API
          version: '1.0'
        x-common-consumes:
        - application/json
        x-common-produces:
        - application/json
        x-common-request-templates:
          application/json: $input.json('$')
        x-common-amazon-responses:
          default:
            statusCode: 200
            responseParameters:
              method.response.header.Access-Control-Allow-Origin: '''*'''
          .*bad-request.*:
            statusCode: 400
            responseParameters:
              method.response.header.Access-Control-Allow-Origin: '''*'''
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
          .*unauthorized.*:
            statusCode: 401
            responseParameters:
              method.response.header.Access-Control-Allow-Origin: '''*'''
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
          .*internal-server-error.*:
            statusCode: 500
            responseParameters:
              method.response.header.Access-Control-Allow-Origin: '''*'''
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
        x-common-swagger-responses:
          '200':
            description: OK
            headers:
              Access-Control-Allow-Origin:
                type: string
          '400':
            description: Bad Request
            headers:
              Access-Control-Allow-Origin:
                type: string
          '401':
            description: Unauthorized
            headers:
              Access-Control-Allow-Origin:
                type: string
          '500':
            description: Internal Server Error
            headers:
              Access-Control-Allow-Origin:
                type: string
        paths:
          /user/create:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${userCreateFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /followee/list:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFolloweesFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /follower/list:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFollowersFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /follower/count:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFollowerCountFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /follower/status:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getIsFollowerStatusFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /followee/count:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFolloweeCountFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /follow/follow:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${followFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /follow/unfollow:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${unfollowFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /feed/list:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFeedItemsFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /story/list:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getStoryItemsFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /status/poststatus:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${postStatusFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /user/get:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getUserFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /user/login:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${loginFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /user/logout:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${logoutFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
          /user/register:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${registerFunction.Arn}/invocations
                requestTemplates:
                  application/json: $input.json('$')
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                  .*bad-request.*:
                    statusCode: 400
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*unauthorized.*:
                    statusCode: 401
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
                  .*internal-server-error.*:
                    statusCode: 500
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: '''*'''
                    responseTemplates:
                      application/json: '{ "error": "$input.path(''$.errorMessage'')"
                        }'
              responses:
                '200':
                  description: OK
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '400':
                  description: Bad Request
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '401':
                  description: Unauthorized
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
                '500':
                  description: Internal Server Error
                  headers:
                    Access-Control-Allow-Origin:
                      type: string
  tweeterLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: tweeterLayer
      Description: dependencies layer for Tweeter server
      ContentUri: ../../layer
      CompatibleRuntimes:
      - nodejs20.x
      RetentionPolicy: DELETE
  userCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: userCreateFunction
      Handler: handlers/users/UserCreateHandler.userCreateHandler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /user/create
            Method: POST
      CodeUri: userCreateFunction
    Metadata:
      SamResourceId: userCreateFunction
  getFolloweesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFolloweesFunction
      Handler: lambda/follow/GetFolloweesLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /followee/list
            Method: POST
      CodeUri: getFolloweesFunction
    Metadata:
      SamResourceId: getFolloweesFunction
  getFolloweeCountFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFolloweeCountFunction
      Handler: lambda/follow/GetFolloweeCountLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /followee/count
            Method: POST
      CodeUri: getFolloweeCountFunction
    Metadata:
      SamResourceId: getFolloweeCountFunction
  getFollowersFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFollowersFunction
      Handler: lambda/follow/GetFollowersLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /follower/list
            Method: POST
      CodeUri: getFollowersFunction
    Metadata:
      SamResourceId: getFollowersFunction
  getFollowerCountFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFollowerCountFunction
      Handler: lambda/follow/GetFollowerCountLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /follower/count
            Method: POST
      CodeUri: getFollowerCountFunction
    Metadata:
      SamResourceId: getFollowerCountFunction
  getIsFollowerStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getIsFollowerStatusFunction
      Handler: lambda/follow/GetIsFollowerStatusLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /follower/status
            Method: POST
      CodeUri: getIsFollowerStatusFunction
    Metadata:
      SamResourceId: getIsFollowerStatusFunction
  followFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: followFunction
      Handler: lambda/follow/FollowLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /follow/follow
            Method: POST
      CodeUri: followFunction
    Metadata:
      SamResourceId: followFunction
  unfollowFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: unfollowFunction
      Handler: lambda/follow/UnfollowLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /follow/unfollow
            Method: POST
      CodeUri: unfollowFunction
    Metadata:
      SamResourceId: unfollowFunction
  getFeedItemsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFeedItemsFunction
      Handler: lambda/status/GetFeedItemsLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /feed/list
            Method: POST
      CodeUri: getFeedItemsFunction
    Metadata:
      SamResourceId: getFeedItemsFunction
  getStoryItemsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getStoryItemsFunction
      Handler: lambda/status/GetStoryItemsLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /story/list
            Method: POST
      CodeUri: getStoryItemsFunction
    Metadata:
      SamResourceId: getStoryItemsFunction
  postStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: postStatusFunction
      Handler: lambda/status/PostStatusLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /status/poststatus
            Method: POST
      CodeUri: postStatusFunction
    Metadata:
      SamResourceId: postStatusFunction
  getUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getUserFunction
      Handler: lambda/user/GetUserLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /user/get
            Method: POST
      CodeUri: getUserFunction
    Metadata:
      SamResourceId: getUserFunction
  loginFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: loginFunction
      Handler: lambda/user/LoginLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /user/login
            Method: POST
      CodeUri: loginFunction
    Metadata:
      SamResourceId: loginFunction
  logoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: logoutFunction
      Handler: lambda/user/LogoutLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /user/logout
            Method: POST
      CodeUri: logoutFunction
    Metadata:
      SamResourceId: logoutFunction
  registerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: registerFunction
      Handler: lambda/user/RegisterLambda.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonSESFullAccess
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonS3FullAccess
      - AmazonSQSFullAccess
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: tweeterApi
            Path: /user/register
            Method: POST
      CodeUri: registerFunction
    Metadata:
      SamResourceId: registerFunction
  usersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Users
      AttributeDefinitions:
      - AttributeName: alias
        AttributeType: S
      KeySchema:
      - AttributeName: alias
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  followTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: follow
      AttributeDefinitions:
      - AttributeName: follower_alias
        AttributeType: S
      - AttributeName: followee_alias
        AttributeType: S
      KeySchema:
      - AttributeName: follower_alias
        KeyType: HASH
      - AttributeName: followee_alias
        KeyType: RANGE
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      GlobalSecondaryIndexes:
      - IndexName: follow_index
        KeySchema:
        - AttributeName: followee_alias
          KeyType: HASH
        - AttributeName: follower_alias
          KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        Projection:
          ProjectionType: ALL
  sessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: AuthTokens
      AttributeDefinitions:
      - AttributeName: token_hash
        AttributeType: S
      - AttributeName: user_alias
        AttributeType: S
      KeySchema:
      - AttributeName: token_hash
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      TimeToLiveSpecification:
        AttributeName: expires_at
        Enabled: true
      GlobalSecondaryIndexes:
      - IndexName: user_index
        KeySchema:
        - AttributeName: user_alias
          KeyType: HASH
        Projection:
          ProjectionType: ALL
  statusTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Status
      AttributeDefinitions:
      - AttributeName: user_alias
        AttributeType: S
      - AttributeName: timestamp
        AttributeType: N
      KeySchema:
      - AttributeName: user_alias
        KeyType: HASH
      - AttributeName: timestamp
        KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
      - IndexName: timestamp_index
        KeySchema:
        - AttributeName: timestamp
          KeyType: HASH
        Projection:
          ProjectionType: ALL
  profilePicsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: ${AWS::StackName}-profile-pics-try1
